name: Build Windows EXE

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch: # 允许手动点击触发

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1. 拉取代码
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. 配置 Node.js (用于编译前端)
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    # 3. 编译前端 Vue
    - name: Build Frontend
      run: |
        cd frontend
        npm install
        npm run build
        # 验证生成结果
        dir dist

    # 4. 配置 Python (用于编译后端)
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 5. 安装 Python 依赖
    - name: Install Python Dependencies
      run: |
        pip install -r requirements.txt

    # 6. 使用 PyInstaller 打包
    - name: Build EXE with PyInstaller
      run: |
        # 这里的关键是 --add-data，把前端编译好的 dist 文件夹打入 exe 内部
        # 格式：源路径;目标路径 (Windows下用分号)
        pyinstaller --noconfirm --onefile --windowed --name "庆阳工学平台" --add-data "frontend/dist;frontend/dist" --hidden-import "uvicorn.logging" --hidden-import "uvicorn.loops" --hidden-import "uvicorn.loops.auto" --hidden-import "uvicorn.protocols" --hidden-import "uvicorn.protocols.http" --hidden-import "uvicorn.protocols.http.auto" --hidden-import "uvicorn.lifespan" --hidden-import "uvicorn.lifespan.on" backend/main.py

    # 7. 上传生成的 EXE 供下载
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Qingyang-Platform-Windows-EXE
        path: dist/庆阳工学平台.exe